#!/usr/bin/env bash

set -e

install_tinyproxy() (
    echo "Installing tinyproxy (this is a one-time setup)..."

    local VERSION="1.11.1"
    local workdir="/tmp/tinyproxy"
    local zipfilename="tinyproxy-${VERSION}.tar.gz"

    rm -rf $workdir
    mkdir $workdir
    cd $workdir

    wget "https://github.com/tinyproxy/tinyproxy/releases/download/${VERSION}/${zipfilename}"
    tar -xzf $zipfilename
    cd "tinyproxy-${VERSION}"

    ./configure \
        --enable-reverse \
        --enable-upstream \
        --enable-filter \
        --enable-xtinyproxy \
        --enable-transparent \

    make

    echo "root privileges are required to install tinyproxy into /usr/local/bin"
    sudo make install

    rm -rf $workdir
)

if ! command -v tinyproxy > /dev/null || ! test -z "${FORCE_INSTALL_TINYPROXY}"
then
    install_tinyproxy
fi

tinyproxy -d -c tinyproxy.conf