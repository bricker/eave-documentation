steps:
- name: python:3.11.2
  dir: apps/core
  entrypoint: python
  args: ['-m', 'pip', 'install', '--user', '-r', 'requirements.txt', '-r', 'requirements-dev.txt', '-r', '$_EAVE_HOME/develop/python/requirements-dev.txt']
  env:
  - EAVE_HOME=$_EAVE_HOME
  - CI=1
  - VERBOSE=1

- name: python:3.11.2
  dir: apps/core
  entrypoint: 'bin/lint'
  env:
  - EAVE_HOME=$_EAVE_HOME
  - CI=1
  - VERBOSE=1

- name: python:3.11.2
  dir: apps/core
  entrypoint: 'bin/test'
  env:
  - EAVE_HOME=$_EAVE_HOME
  - CI=1
  - VERBOSE=1

- name: python:3.11.2
  dir: apps/core
  entrypoint: python
  args: ['-m', 'alembic', 'upgrade', 'head']
  env:
  - EAVE_HOME=$_EAVE_HOME
  - CI=1
  - VERBOSE=1
  secretEnv:
  - EAVE_DB_HOST
  - EAVE_DB_USER
  - EAVE_DB_PASS
  - EAVE_DB_NAME

- name: ubuntu
  dir: apps/core
  entrypoint: $_EAVE_HOME/develop/shared/bin/setup-deployment-workspace
  env:
  - EAVE_HOME=$_EAVE_HOME
  - CI=1
  - VERBOSE=1

- name: python:3.11.2
  dir: .build/core
  entrypoint: python
  args: ['-m', 'pip', 'install', '-t', 'vendor', '-r', 'requirements-vendor.txt']

- name: gcr.io/google.com/cloudsdktool/cloud-sdk
  dir: .build/core
  entrypoint: 'bash'
  args: ['-c', 'gcloud', 'app', 'deploy', '--version=${REF_NAME}', '--appyaml=app.${PROJECT_ID}.yaml']
  env:
  - "GOOGLE_CLOUD_PROJECT='$PROJECT_ID'"

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/EAVE_DB_HOST/versions/latest
    env: 'EAVE_DB_HOST'
  - versionName: projects/$PROJECT_ID/secrets/EAVE_DB_USER/versions/latest
    env: 'EAVE_DB_USER'
  - versionName: projects/$PROJECT_ID/secrets/EAVE_DB_PASS/versions/latest
    env: 'EAVE_DB_PASS'
  - versionName: projects/$PROJECT_ID/secrets/EAVE_DB_NAME/versions/latest
    env: 'EAVE_DB_NAME'

substitutions:
  _EAVE_HOME: /workspace

timeout: '1600s'
