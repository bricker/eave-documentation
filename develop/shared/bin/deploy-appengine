#!/usr/bin/env -S bash -eu

source $EAVE_HOME/develop/functions.bash

function deploy() (
	local project=$(~gcloudproject)

	while getopts "p:" argname
	do
		case "$argname" in
			p)
				if test "$OPTARG" = "prod"; then
					project="eave-production"
				else
					project="eavefyi-dev"
				fi
				;;
		esac
	done

	local appyaml="app.$project.yaml"
	test -f $appyaml

	local timestamp=$(date --utc "+%Y%m%dt%H%Mz")
	local gitrev=$(git rev-parse --short HEAD)
	local version="$timestamp-$gitrev"

	gcloud --project=$project meta list-files-for-upload | grep -v "^vendor"
	gcloud --project=$project app deploy --version=$version --appyaml=$appyaml

	# local service=$(cat $appyaml | yq '.service')
	# local tagname="$service-$version"
	# git tag -am $tagname $tagname
	# git push origin $tagname
)

deploy "$@"